# CSV Loader

REST API для загрузки CSV файлов с информацией о компаниях в базу данных.

## Описание

Основная функция - загрузка реальных справочников регионов, районов, городов и  организаций с их контактной информацией. В итоге получаем заполненную приличным объемом таблицы, готовых к написанию сложных запросов. Можно подключать разные базы для наполнения. 

Подход - модульный монолит [PHP Controller] → [PHP Service] → [PHP Repository] → [MySQL]

## Требования к системе

- PHP 8.1 или выше
- Composer
- MySQL 8 или выше
- Веб-сервер (опционально)


## API

### Проверка работоспособности

**GET** `/healthz`

Проверяет работоспособность API.

#### Пример ответа

```json
{
  "message": "OK"
}
```

### Загрузка CSV файла

**POST** `/upload`

Загружает CSV файл с информацией о компаниях в базу данных.

```bash
curl -X POST http://localhost/upload \
  -F "files[0]=@companies1.csv" \
  -F "files[1]=@companies2.csv" \
  -H "Content-Type: multipart/form-data"

```

#### Параметры запроса

- `files[]` (обязательный) - CSV файлы с данными о компаниях

#### Формат CSV файла

CSV файл должен содержать следующие колонки, разделенные точкой с запятой:

- `ID` - уникальный идентификатор компании
- `Название` - название компании
- `Регион` - регион расположения
- `Район` - район расположения
- `Город` - город расположения
- `Район города` - район города
- `Адрес` - почтовый адрес компании
- `Телефон` - контактный телефон компании
- `Мобильный телефон` - мобильный телефон компании
- `Email` - email компании
- `Сайт` - веб-сайт компании
- `Рубрика` - основная рубрика деятельности
- `Подрубрика` - подрубрика деятельности

#### Пример ответа

```json
{
  "message": "Файлы успешно загружены",
  "summary": {
    "total": 733,
    "imported": 733,
    "files": [
      "Автосервис самообслуживания.csv",
      "Аэрография на транспорте.csv"
    ]
  }
}
```

Пример содержимого файла `companies.csv`:

```
ID;Название;Регион;Район;Город;Район города;Адрес;Индекс;Телефон;Мобильный телефон;Email;Сайт;Рубрика;Подрубрика;
1;ООО "Рога и Копыта";Московская область;Красногорский район;Красногорск;;;;+7(495)123-45-67;;info@rok.ru;www.rok.ru;Автосервис;Автосервис самообслуживания;
```

# Docker (развертывание)

Может работать отдельно от других докер-проектов. Но нужна база, например, Mysql. Приложение использует встроенный PHP сервер (`php -S`) и для него не требуется Apache/Nginx. Маршрутизация через `index.php` и `Router`.

База данных должна быть настроена отдельно и готова к работе. Нужно только создать отдельную базу `csv` куда и будут импортироваться данные из CSV-файлов.

### 1. Сборка образа

```bash
docker build -t csv-loader .
```

### 2. Запуск контейнера

```bash
docker run -d \
  --name csv-loader-app \
  -p 8001:8001 \
  -v $(pwd)/config:/var/www/html/config \
  -v $(pwd)/database:/var/www/html/database \
  -v $(pwd)/src:/var/www/html/src \
  -v $(pwd)/index.php:/var/www/html/index.php \
  csv-loader
```

Приложение будет доступно по адресу: `http://localhost:8001`

```bash
# Запуск миграций
docker exec -it csv-loader-app php database/run.php 001_init up

# Проверка работоспособности
curl http://localhost:8001/healthz

# Для отката миграций
php database/run.php 001_init down

```

**Важно:** Перед запуском настройте `config/db.php` с параметрами подключения к вашей базе данных.
