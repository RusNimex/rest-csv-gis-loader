# Company Loader API

REST API для загрузки CSV файлов с информацией о компаниях в базу данных.

## Описание

Основная функция - загрузка реальных справочников регионов, районов, городов и  организаций с их контактной информацией. В итоге получаем заполненную приличным объемом таблицы, готовых к написанию сложных запросов. Можно подключать разные базы для наполнения.

## Требования к системе

- PHP 8.1 или выше
- Composer
- MySQL 8 или выше
- Веб-сервер (опционально)

## Установка

Есть зависимости, которые необходимо установить:
```bash
composer install
```

Создайте базу данных и настройте параметры подключения PDO в файле `config/db.php`:
```php
return [
      'host' => '127.0.0.1',
      'dbname' => 'csv',
      'username' => 'root',
      'password' => 'root',
      'charset' => 'utf8mb4',
      'options' => [
         PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
         PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
         PDO::ATTR_EMULATE_PREPARES => false,
         PDO::ATTR_PERSISTENT => true,
      ],
];
```

Создание начального состояния базы данных:
```bash
php database/run.php 001_init up
```

Для отката миграций используйте команду:
```bash
php database/run.php 001_init down
```

Для тестирования и локальной разработки можно запустить через:
```bash
php -S localhost:8000 index.php
```

## API

### Загрузка CSV файла

**POST** `/upload`

Загружает CSV файл с информацией о компаниях в базу данных.

#### Параметры запроса

- `files[]` (обязательный) - CSV файлы с данными о компаниях

#### Формат CSV файла

CSV файл должен содержать следующие колонки, разделенные точкой с запятой:

- `ID` - уникальный идентификатор компании
- `Название` - название компании
- `Регион` - регион расположения
- `Район` - район расположения
- `Город` - город расположения
- `Район города` - район города
- `Адрес` - почтовый адрес компании
- `Телефон` - контактный телефон компании
- `Мобильный телефон` - мобильный телефон компании
- `Email` - email компании
- `Сайт` - веб-сайт компании
- `Рубрика` - основная рубрика деятельности
- `Подрубрика` - подрубрика деятельности

#### Пример ответа

```json
{
  "message": "Файлы успешно загружены",
  "summary": {
    "total": 733,
    "imported": 733,
    "files": [
      "Автосервис самообслуживания.csv",
      "Аэрография на транспорте.csv"
    ]
  }
}
```

### Проверка работоспособности

**GET** `/healthz`

Проверяет работоспособность API.

#### Пример ответа

```json
{
  "message": "OK"
}
```

## Структура базы данных

База данных состоит из следующих таблиц:

- `company` - информация о компаниях
- `company_phones` - телефоны компаний
- `region` - регионы
- `district` - районы
- `city` - города
- `geo` - связь между регионами, районами и городами
- `company_geo` - связь компаний с географическими данными

## Пример использования

### Загрузка CSV файла

```bash
curl -X POST http://localhost/upload \
  -F "files[0]=@companies1.csv" \
  -F "files[1]=@companies2.csv" \
  -H "Content-Type: multipart/form-data"

```

Пример содержимого файла `companies.csv`:

```
ID;Название;Регион;Район;Город;Район города;Адрес;Индекс;Телефон;Мобильный телефон;Email;Сайт;Рубрика;Подрубрика;Рейтинг;Кол-во отзывов;Кол-во оценок;Время работы;Способы оплаты;whatsapp;viber;telegram;facebook;instagram;vkontakte;odnoklassniki;youtube;twitter;skype;icq;googleplus;linkedin;pinterest;Широта;Долгота
1;ООО "Рога и Копыта";Московская область;Красногорский район;Красногорск;;;;+7(495)123-45-67;;info@rok.ru;www.rok.ru;Автосервис;Автосервис самообслуживания;4.5;10;15;Пн-Пт: 9:00-18:00;Наличные, Карта;;;;;;;https://vk.com/rok;;;;;;;;55.7558;37.6176
```
